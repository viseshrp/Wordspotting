var background=(function(){"use strict";function L(t){return t==null||typeof t=="function"?{main:t}:t}const s=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,T=s.storage.sync;function S(t){return T.set(t)}function a(t){return T.get(t)}function A(t){var e=new Date,n=e.toUTCString();console.log(`[${n}]	${t}`)}function E(t){if(!t||typeof t!="string")return null;const e=t.trim();if(!e)return null;try{return new RegExp(e,"i")}catch{const i=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/\\\*/g,".*");try{return new RegExp(i,"i")}catch{return null}}}function g(t,e){return!t||!Array.isArray(e)||e.length===0?!1:e.some(n=>{const o=E(n);return o?o.test(t):!1})}function B(t){return Array.isArray(t)?t.map(e=>E(e)).filter(e=>e!==null):[]}function f(t,e){if(!t||!Array.isArray(e)||e.length===0)return!1;const n=[t];try{const o=new URL(t);n.push(`${o.hostname}${o.pathname}`)}catch{}return e.some(o=>n.some(i=>o.test(i)))}const w="wordspotting_settings_version",N=1,_={wordspotting_notifications_on:!0,wordspotting_extension_on:!0,wordspotting_highlight_on:!1,wordspotting_highlight_color:"#FFFF00",wordspotting_website_list:[],wordspotting_word_list:[],wordspotting_theme:"system",is_first_start:!1};async function j(){const t=[...Object.keys(_),w],e=await a(t),n={};Object.keys(_).forEach(o=>{typeof e[o]>"u"&&(n[o]=_[o])}),typeof e[w]>"u"&&(n[w]=N),Object.keys(n).length>0&&await S(n)}const F=["/injected.js"],R=["/css/index.css"];let r=[];const p=new Map,h=new Map,v="#4caf50",I="#9e9e9e",U="-",P=L(()=>{s.runtime.onInstalled.addListener(async t=>{try{await j(),await y(),t.reason==="install"&&(A("First start initialization complete."),s.tabs.create({url:s.runtime.getURL("/options.html")}))}catch(e){console.error("Error during initialization:",e)}}),s.runtime.onMessage.addListener((t,e)=>x(t,e)),s.tabs.onUpdated.addListener((t,e,n)=>{e.status==="complete"&&n.url&&C(t,n.url)}),s.tabs.onActivated.addListener(t=>{s.tabs.get(t.tabId).then(e=>{!e||!e.id||O(e.id,e.url)}).catch(()=>{})}),s.tabs.onRemoved.addListener(t=>{p.delete(t),h.delete(t)}),s.storage.onChanged.addListener((t,e)=>{if(e!=="sync")return;const n=t;!n.wordspotting_website_list&&!n.wordspotting_extension_on&&!n.wordspotting_highlight_on&&!n.wordspotting_highlight_color||(n.wordspotting_website_list&&y(),s.tabs.query({active:!0,currentWindow:!0}).then(o=>{const i=o[0];!i||!i.id||(O(i.id,i.url),n.wordspotting_extension_on?.newValue===!0?C(i.id,i.url):n.wordspotting_extension_on?.newValue===!1&&c(i.id),s.tabs.sendMessage(i.id,{from:"background",subject:"settings_updated"}).catch(()=>{}))}))}),Object.assign(globalThis,{handleMessage:x,setCountBadge:d,refreshAllowedSitePatterns:y,saveToStorage:S}),Object.defineProperty(globalThis,"compiledAllowedSites",{get:()=>r})});async function x(t,e){if(t&&typeof t.wordfound=="boolean"&&typeof t.keyword_count=="number"){const o=e?.tab?.id,i=e?.tab?.url,l=await a(["wordspotting_extension_on","wordspotting_website_list"]);if(l.wordspotting_extension_on===!1)return o&&c(o),{ack:"disabled"};const m=l.wordspotting_website_list||[];if(!(i?r.length>0?f(i,r):g(i,m):!0))return o&&c(o),{ack:"not_allowed"};if(o&&(h.set(o,t.keyword_count),d(o,t.keyword_count)),o!=null){const z=p.get(o)??!1;p.set(o,t.wordfound===!0),!z&&t.wordfound===!0&&(await a("wordspotting_notifications_on")).wordspotting_notifications_on&&(A("Firing notification!"),$("/assets/ws48.png","basic","Keyword found!",e.tab?e.tab.title:"Page",1))}return{ack:"gotcha"}}return{ack:"ignored"}}function $(t,e,n,o,i){var m={iconUrl:s.runtime.getURL(t),type:e,title:n,message:o,priority:i};s.notifications.create("",m)}async function C(t,e){if(e)try{const n=await a(["wordspotting_extension_on","wordspotting_website_list"]);if(n.wordspotting_extension_on===!1)return;const o=n.wordspotting_website_list||[];if(!(r.length>0?f(e,r):g(e,o))){c(t);return}d(t,0),await D(t),await V(t)}catch(n){console.error("Error during dynamic injection:",n)}}async function D(t){try{await s.scripting.insertCSS({target:{tabId:t},files:R})}catch(e){console.warn("Style injection skipped:",e)}}async function V(t){await G(t)||await s.scripting.executeScript({target:{tabId:t},files:F})}async function y(){try{const t=await a("wordspotting_website_list");r=B(t.wordspotting_website_list||[])}catch(t){console.warn("Failed to refresh allowed site patterns:",t),r=[]}}async function O(t,e){try{const n=await a(["wordspotting_extension_on","wordspotting_website_list"]);if(n.wordspotting_extension_on===!1){c(t);return}if(e){const i=n.wordspotting_website_list||[];if(!(r.length>0?f(e,r):g(e,i))){c(t);return}}const o=h.get(t)??0;d(t,o)}catch(n){console.warn("Unable to update badge status:",n)}}function k(t,e,n){s.action.setBadgeText({tabId:t,text:e}),n&&s.action.setBadgeBackgroundColor({tabId:t,color:n})}function c(t){k(t,U,I)}function d(t,e){const n=e>0?String(e):"0";k(t,n,v)}async function G(t){try{const e=await s.scripting.executeScript({target:{tabId:t},func:()=>!!globalThis.__WORDSPOTTING_CONTENT_LOADED__}),[n]=e;return!!n?.result}catch{return!1}}function K(){}function u(t,...e){}const M={debug:(...t)=>u(console.debug,...t),log:(...t)=>u(console.log,...t),warn:(...t)=>u(console.warn,...t),error:(...t)=>u(console.error,...t)};let b;try{b=P.main(),b instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(t){throw M.error("The background crashed on startup!"),t}return b})();
