import{g as m,c as a,m as x,s as y,a as E,d as I,e as S}from"./utils-CGS83D2H.js";document.addEventListener("DOMContentLoaded",()=>{const c=document.getElementById("keyword_container"),g=document.getElementById("add_current_site"),v=document.getElementById("add_site_section"),s=document.getElementById("site_scope_select"),l=document.getElementById("refresh_on_add"),L=[{value:"root",label:"Root domain"},{value:"subdomain",label:"This subdomain"},{value:"path",label:"URL path"},{value:"full",label:"Full URL (exact match)"}],p="wordspotting_refresh_on_add";m("wordspotting_theme").then(t=>{const e=t.wordspotting_theme||"system";k(e)}),m(p).then(t=>{l&&(l.checked=t[p]!==!1)}),a.tabs.query({active:!0,currentWindow:!0}).then(t=>{var e=t[0];e&&(A(e).then(o=>{if(!o.allowed){h(!0),u("This site is not in your allowed list.");return}if(h(!1),!o.hasPermission){h(!0),u("Permission not granted for this site.");return}e.id&&a.tabs.sendMessage(e.id,{from:"popup",subject:"word_list_request"}).then(n=>{if(n){T(n.word_list);const i=n.word_list?n.word_list.length:0;a.action.setBadgeText({text:i>0?i.toString():"0",tabId:e.id})}}).catch(n=>{u("Not active on this page."),console.warn(n)})}),e.url&&w(e.url))}),g&&g.addEventListener("click",()=>{a.tabs.query({active:!0,currentWindow:!0}).then(async t=>{const e=t[0];if(!e||!e.url)return;const o=P(),n=B(e.url,o);try{const i=await m("wordspotting_website_list"),b=Array.isArray(i.wordspotting_website_list)?i.wordspotting_website_list:[],f=x(b,[n]);await y({wordspotting_website_list:f}),E(`Added "${n}" to allowlist`,"Saved",!0),h(!1),window.close(),l?.checked&&e.id&&a.tabs.reload(e.id)}catch(i){console.error("Failed to add site to allowlist",i),E("Could not save site.","Error",!1)}})}),l&&l.addEventListener("change",()=>{y({[p]:l.checked}).catch(t=>console.error("Failed to save refresh setting",t))}),s&&s.addEventListener("change",()=>{a.tabs.query({active:!0,currentWindow:!0}).then(t=>{const e=t[0];e?.url&&w(e.url)})});const _=document.getElementById("options_btn");_&&_.addEventListener("click",()=>{a.runtime.openOptionsPage?a.runtime.openOptionsPage():window.open(a.runtime.getURL("/options.html"))});function T(t){if(!c)return;if(c.innerHTML="",!t||t.length===0){u("No keywords found.");return}[...new Set(t)].forEach(o=>{const n=document.createElement("span");n.className="chip",n.textContent=o,c.appendChild(n)})}function u(t){c&&(c.innerHTML=`<div class="empty-state">${t}</div>`)}function k(t){const e=document.documentElement;t==="light"?e.setAttribute("data-theme","light"):t==="dark"?e.setAttribute("data-theme","dark"):e.removeAttribute("data-theme")}async function A(t){try{if(!t.url)return{allowed:!1,hasPermission:!1};const o=(await m("wordspotting_website_list")).wordspotting_website_list||[],n=I(t.url,o);return w(t.url),{allowed:n,hasPermission:!0}}catch(e){return console.error("Activation check failed:",e),{allowed:!1,hasPermission:!1}}}function P(){return s?.value||"root"}function B(t,e){const n=S(t)[e];if(!n)throw new Error("Invalid URL");return n}function w(t){try{q(t)}catch(e){console.warn("Failed to update scope options",e)}}function q(t){if(!s)return;const e=s.value||"root",o=new Set,n=[],i=S(t);if(L.forEach(r=>{const d=i[r.value]||"";!d||o.has(d)||(o.add(d),n.push({value:r.value,text:`${r.label} (${d})`}))}),s.innerHTML="",n.forEach(r=>{const d=document.createElement("option");d.value=r.value,d.textContent=r.text,s.appendChild(d)}),n.some(r=>r.value===e)){s.value=e;return}const f=n.find(r=>r.value==="root");s.value=f?f.value:n[0]?.value||"root"}function h(t){v&&(v.style.display=t?"":"none")}});
