name: CI

on:
    push:
        branches: [master]
    pull_request:
    workflow_dispatch:

jobs:
    quality:
        name: Code Quality
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Use Node.js 20
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm
            - name: Install Dependencies
              run: make install
            - name: Run Linters
              run: make lint

    smoke:
        name: Smoke Tests
        runs-on: ubuntu-latest
        needs: quality
        steps:
            - uses: actions/checkout@v4
            - name: Use Node.js 20
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm
            - name: Install Dependencies
              run: make install
            - name: Run Smoke Tests
              run: make smoke

    test:
        name: Unit Tests
        runs-on: ubuntu-latest
        needs: [quality, smoke]
        steps:
            - uses: actions/checkout@v4
            - name: Use Node.js 20
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm
            - name: Install Dependencies
              run: make install
            - name: Run Unit Tests
              run: make test

    package:
        name: Build & Package
        runs-on: ubuntu-latest
        needs: test
        steps:
            - uses: actions/checkout@v4
            - name: Use Node.js 20
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm
            - name: Install Dependencies
              run: make install
            - name: Build and Package
              run: make package
            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: wordspotting-extension
                  path: zip/wordspotting-*.zip

    release:
        name: Release
        runs-on: ubuntu-latest
        needs: package
        if: startsWith(github.ref, 'refs/tags/v')
        steps:
            - uses: actions/checkout@v4
            - name: Download Artifact
              uses: actions/download-artifact@v4
              with:
                  name: wordspotting-extension
            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  files: wordspotting-*.zip # The artifact is downloaded to the root
                  draft: true
